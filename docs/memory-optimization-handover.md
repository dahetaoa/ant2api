# ant2api å†…å­˜ä¼˜åŒ– - äº¤æ¥æ–‡æ¡£

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### ç°è±¡
å½“å‘ API ä¼ å…¥åŒ…å«å›¾ç‰‡çš„è¯·æ±‚æ—¶ï¼ˆä¾‹å¦‚ 3 å¼  1MB çš„å›¾ç‰‡ï¼‰ï¼Œå®¹å™¨å†…å­˜ä» ~6MB æš´æ¶¨åˆ° ~62MBï¼Œæ”¾å¤§çº¦ 10-15 å€ã€‚å³ä½¿å›¾ç‰‡æ•°æ®ä¸éœ€è¦ä»»ä½•å¤„ç†ï¼Œåªæ˜¯æ ¼å¼è½¬æ¢åé€ä¼ åˆ°åç«¯ï¼Œä¹Ÿä¼šäº§ç”Ÿå¦‚æ­¤å¤§çš„å†…å­˜å¼€é”€ã€‚

### æ ¹å› åˆ†æ
å½“å‰å®ç°é‡‡ç”¨ã€Œå®Œæ•´è§£æ â†’ ç»“æ„ä½“è½¬æ¢ â†’ é‡æ–°åºåˆ—åŒ–ã€çš„æ¨¡å¼ï¼š

```
åŸå§‹è¯·æ±‚ (4MB)
    â†“ io.ReadAll()           â†’ å‰¯æœ¬ #1
    â†“ json.Unmarshal()       â†’ å‰¯æœ¬ #2 (CopyString=true å¯¼è‡´å­—ç¬¦ä¸²å¤åˆ¶)
    â†“ ToVertexRequest()      â†’ å‰¯æœ¬ #3 (æ„å»ºæ–°ç»“æ„ä½“)
    â†“ json.Marshal()         â†’ å‰¯æœ¬ #4 (åºåˆ—åŒ–å‘é€)
    
å³°å€¼å†…å­˜: 4MB Ã— 4 + Goè¿è¡Œæ—¶å¼€é”€ â‰ˆ 60MB
```

### æ ¸å¿ƒæ´å¯Ÿ
**å›¾ç‰‡çš„ base64 æ•°æ®åœ¨ OpenAI æ ¼å¼å’Œ Vertex æ ¼å¼ä¸­æ˜¯å®Œå…¨ç›¸åŒçš„å­—èŠ‚**ï¼Œåªæ˜¯å¤–å±‚ JSON é”®åä¸åŒã€‚æ²¡æœ‰å¿…è¦è§£æå‡ºæ¥å†åºåˆ—åŒ–å›å»ã€‚

---

## ğŸ’¡ ä¼˜åŒ–æ€è·¯ï¼šé€‰æ‹©æ€§è§£æ + å¼•ç”¨æ‹¼æ¥

### æ ¸å¿ƒåŸåˆ™
> **åªè§£æéœ€è¦ã€Œç†è§£ã€çš„å­—æ®µï¼Œå¼•ç”¨éœ€è¦ã€Œä¼ é€’ã€çš„æ•°æ®å—**

### å­—æ®µåˆ†ç±»

| ç±»å‹ | å¤„ç†æ–¹å¼ | ç¤ºä¾‹ |
|------|----------|------|
| **å†³ç­–å­—æ®µ** | è§£æ | model, stream, role, type |
| **é€ä¼ æ•°æ®å—** | å®šä½ + å¼•ç”¨ | content, reasoning, data (base64), tool arguments |

### ç›®æ ‡æ•°æ®æµ

```
åŸå§‹è¯·æ±‚ (4MB)
    â†“ éƒ¨åˆ†è§£æ (åªè§£æå…ƒæ•°æ®)
    â†“ å®šä½å¤§å—æ•°æ®çš„ä½ç½® (åç§»é‡)
    â†“ æ¨¡æ¿åŒ–æ„å»ºè¾“å‡º (ç›´æ¥å¼•ç”¨åŸå§‹å­—èŠ‚)
    
å³°å€¼å†…å­˜: åŸå§‹è¯·æ±‚ + è¾“å‡ºç¼“å†²åŒº â‰ˆ 5-8MB
```

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆæ¦‚è¿°

### æ–¹æ¡ˆä¸€ï¼šjson.RawMessage å»¶è¿Ÿè§£æï¼ˆæ¨èï¼Œæ”¹åŠ¨è¾ƒå°ï¼‰

ä¿®æ”¹è¯·æ±‚ç»“æ„ä½“ï¼Œå¯¹å¤§å­—æ®µä½¿ç”¨ `json.RawMessage`ï¼š

```go
type Message struct {
    Role    string          `json:"role"`
    Content json.RawMessage `json:"content"`  // ä¸ç«‹å³è§£æ
    // ...
}
```

æ„å»º Vertex è¯·æ±‚æ—¶æŒ‰éœ€å¤„ç† Contentï¼Œé¿å…å®Œæ•´ååºåˆ—åŒ–ã€‚

### æ–¹æ¡ˆäºŒï¼šsonic.ast.Node æƒ°æ€§è§£æ

ä½¿ç”¨ sonic çš„ AST API æŒ‰è·¯å¾„è®¿é—®å­—æ®µï¼š

```go
root, _ := sonic.Get(body)
model := root.Get("model").String()  // åªè§£æéœ€è¦çš„
messages := root.Get("messages")      // ä¿æŒä¸º Nodeï¼ŒæŒ‰éœ€å±•å¼€
```

### æ–¹æ¡ˆä¸‰ï¼šæµå¼ JSON æ„å»ºå™¨ï¼ˆæœ€å½»åº•ï¼‰

è¾“å‡ºæ—¶ä¸æ„å»ºå®Œæ•´ç»“æ„ï¼Œç›´æ¥æµå¼å†™å…¥ï¼š

```go
w.Write(`{"model":"` + model + `","request":{"contents":[`)
// ç›´æ¥å†™å…¥åŸå§‹è¯·æ±‚ä¸­å®šä½åˆ°çš„æ•°æ®å—
w.Write(rawRequest[contentStart:contentEnd])
w.Write(`]}}`)
```

---

## ğŸ“¦ é€‚ç”¨èŒƒå›´

æ­¤æ€è·¯å¯æ‹“å±•åˆ°æ‰€æœ‰è¯·æ±‚/å“åº”å¤„ç†ï¼š

| åœºæ™¯ | å¤§å—æ•°æ® | é€‚ç”¨æ€§ |
|------|----------|--------|
| å›¾ç‰‡è¯·æ±‚ | base64 data | âœ… å®Œç¾é€‚ç”¨ |
| é•¿æ–‡æœ¬è¯·æ±‚ | content å­—ç¬¦ä¸² | âœ… é€‚ç”¨ |
| thinking å“åº” | reasoning å­—æ®µ | âœ… é€‚ç”¨ |
| å·¥å…·è°ƒç”¨ | arguments JSON | âœ… é€‚ç”¨ |
| æµå¼ SSE | æ¯ä¸ªäº‹ä»¶ | âœ… é€‚ç”¨ï¼ˆå•äº‹ä»¶è¾ƒå°ï¼Œæ”¶ç›Šç•¥ä½ï¼‰|

---

## âš ï¸ è¾¹ç¼˜æƒ…å†µæ³¨æ„

1. **JSON è½¬ä¹‰**ï¼šbase64 åªå« `A-Za-z0-9+/=`ï¼Œæ— éœ€è½¬ä¹‰ï¼›æ™®é€šæ–‡æœ¬åœ¨åŸå§‹ JSON ä¸­å·²è½¬ä¹‰ï¼Œç›´æ¥å¼•ç”¨å®‰å…¨
2. **åµŒå¥—ç»“æ„**ï¼šmessages æ•°ç»„éœ€éå†ï¼Œæ¯ä¸ª message çš„ content å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„
3. **signature ç¼“å­˜**ï¼š`thoughtSignature` éœ€è¦è§£æä»¥ä¾¿ç¼“å­˜äº¤äº’ï¼Œä½†å…³è”çš„ reasoning å†…å®¹å¯å¼•ç”¨
4. **æ ¼å¼æ ¡éªŒ**ï¼šå»ºè®®ä¿ç•™åŸºæœ¬ JSON è¯­æ³•æ ¡éªŒï¼Œå¯åœ¨å®šä½é˜¶æ®µå®Œæˆ

---

## ğŸ“ ç›¸å…³ä»£ç ä½ç½®

- **å…¥å£å¤„ç†**ï¼š`internal/gateway/openai/handler.go` - `HandleChatCompletions()`
- **æ ¼å¼è½¬æ¢**ï¼š`internal/gateway/openai/convert.go` - `ToVertexRequest()`, `extractUserParts()`
- **è¯·æ±‚ç±»å‹**ï¼š`internal/gateway/openai/request.go` - `ChatRequest`, `Message`
- **åç«¯å®¢æˆ·ç«¯**ï¼š`internal/vertex/client.go` - `SendRequest()`, `SendStreamRequest()`
- **JSON å°è£…**ï¼š`internal/pkg/json/json.go` - sonic é…ç½®

---

## âœ… åç»­å»ºè®®

1. **ä¼˜å…ˆå®æ–½æ–¹æ¡ˆä¸€**ï¼ˆjson.RawMessageï¼‰ï¼Œæ”¹åŠ¨æœ€å°ï¼Œæ•ˆæœæ˜æ˜¾
2. å¯ä»¥å…ˆåœ¨å¤„ç†å›¾ç‰‡çš„è·¯å¾„éªŒè¯æ•ˆæœ
3. éªŒè¯æˆåŠŸåï¼Œé€æ­¥æ¨å¹¿åˆ°å…¶ä»–å¤§å—æ•°æ®åœºæ™¯
4. è€ƒè™‘æ·»åŠ è¯·æ±‚å¤§å°çš„ metrics ç›‘æ§ï¼Œé‡åŒ–ä¼˜åŒ–æ•ˆæœ

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

| åœºæ™¯ | å½“å‰æ”¾å¤§å€æ•° | ä¼˜åŒ–å |
|------|-------------|--------|
| 3 å¼  1MB å›¾ç‰‡ | ~15x | ~1.5x |
| é•¿æ–‡æœ¬è¯·æ±‚ | ~10x | ~2x |
| thinking å“åº” | ~8x | ~2x |

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2026-01-23*
*å¦‚æœ‰ç–‘é—®ï¼Œè¯·é€šè¯»ä¸Šè¿°ä»£ç æ–‡ä»¶åï¼ŒåŸºäºã€Œé€‰æ‹©æ€§è§£æ + å¼•ç”¨æ‹¼æ¥ã€çš„æ ¸å¿ƒæ€è·¯ç¼–å†™å…·ä½“ä¿®æ”¹è®¡åˆ’ã€‚*
